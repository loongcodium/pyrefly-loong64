name: Check, build, release!

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'The version to build/release (e.g., 0.1.14). If empty, the latest upstream version will be used after checking for updates.'
        required: false
        default: ''
      release_version:
        description: 'The version to use in release (e.g., 0.1.14-0). If empty, the release workflow will not be triggered.'
        required: false
        default: ''

jobs:
  determine_version:
    name: Determine version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version_logic.outputs.version }}
      release_version: ${{ steps.version_logic.outputs.release_version }}
      should_build: ${{ steps.version_logic.outputs.should_build }}
    steps:
      - name: Determine version and whether to build
        id: version_logic
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "Building specified version: ${{ github.event.inputs.version }}"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "release_version=${{ github.event.inputs.release_version }}" >> $GITHUB_OUTPUT
          else
            echo "Checking for newer upstream version..."
            sudo apt-get update && sudo apt-get install -y jq
            UPSTREAM_VERSION=$(curl -s https://api.github.com/repos/facebook/pyrefly/releases/latest | jq -r .tag_name)
            OWN_VERSION=$(curl -sL https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name || echo "v0.0.0")
            echo "Upstream version: $UPSTREAM_VERSION"
            echo "Own version: $OWN_VERSION"
            UPSTREAM_VERSION_NUM=${UPSTREAM_VERSION#v}
            OWN_VERSION_NUM=${OWN_VERSION#v}
            if dpkg --compare-versions "$UPSTREAM_VERSION_NUM" "gt" "$OWN_VERSION_NUM"; then
              echo "Newer upstream version found: $UPSTREAM_VERSION"
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
              echo "release_version=$UPSTREAM_VERSION-0" >> $GITHUB_OUTPUT
            else
              echo "No newer upstream version found."
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "version=" >> $GITHUB_OUTPUT
              echo "release_version=" >> $GITHUB_OUTPUT
            fi
          fi

  build:
    needs: determine_version
    if: needs.determine_version.outputs.should_build == 'true'
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux
            arch: loong64
            rust_target: loongarch64-unknown-linux-gnu
            github_env: $GITHUB_ENV
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
        with:
          repository: facebook/pyrefly
          ref: ${{ needs.determine_version.outputs.version }}
      
      - uses: actions/checkout@v6
        with:
          path: pyrefly-loong64
          sparse-checkout: |
            patches
      - name: Apply patch
        run: |
          git apply pyrefly-loong64/patches/*.patch
          rm -rf pyrefly-loong64

      - name: Read rust-toolchain file
        # matrix.github_env is necessary to differentiate between windows and linux environment variables
        # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/workflow-commands-for-github-actions#environment-files
        # https://stackoverflow.com/questions/66733076/github-actions-set-environment-variable-for-windows-build-with-powershell
        run: echo "toolchain=$(cat pyrefly/rust-toolchain)" && echo "toolchain=$(cat pyrefly/rust-toolchain)" >> ${{ matrix.github_env }}
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.toolchain }}
      - name: set up rust cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: pyrefly-extension
      - name: Set JEMALLOC_SYS_WITH_LG_PAGE=16 for `cross`
        if: ${{ matrix.rust_target == 'loongarch64-unknown-linux-gnu' }}
        run: echo "target.${{ matrix.rust_target }}.env.passthrough=[\"JEMALLOC_SYS_WITH_LG_PAGE=16\"]" > Cross.toml
      - name: build pyrefly binary (cross-compile)
        if: ${{ matrix.rust_target != '' }}
        uses: houseabsolute/actions-rust-cross@v1
        with:
          command: build
          target: ${{ matrix.rust_target }}
          args: "--release --artifact-dir lsp/bin --manifest-path pyrefly/Cargo.toml -Z unstable-options"
          toolchain: ${{ env.toolchain }}
          cross-version: fb2bd30 # Latest version with LoongArch64 support currently

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm
      - name: Patch metadata
        run: |
          cat package.json | \
          jq '.displayName="Pyrefly (loong64)"' | \
          jq '.description=(.description) + " (This version is for LoongArch64 only)"' | \
          jq '.version=("${{ needs.determine_version.outputs.release_version }}"|ltrimstr("v"))' | \
          jq '.publisher="loong-vsx"' | \
          jq '.homepage="https://github.com/loongcodium/pyrefly-loong64"' | \
          jq '.repository.url="https://github.com/loongcodium/pyrefly-loong64.git"' | \
          jq '.bugs.url="https://github.com/loongcodium/pyrefly-loong64/issues"' \
          > tmp.json && mv -v tmp.json package.json
        working-directory: lsp/
      - name: save platform name
        run: echo "platform=${{ matrix.platform }}-${{ matrix.arch }}" >> ${{ matrix.github_env }}
      - run: npm ci
        working-directory: lsp/
      - run: npx vsce package
        working-directory: lsp/
      - uses: actions/upload-artifact@v6
        with:
          name: pyrefly-${{ env.platform }}
          path: "lsp/*.vsix"

  release:
    name: release
    runs-on: ubuntu-latest
    needs: [determine_version, build]
    if: needs.determine_version.outputs.should_build == 'true' && needs.determine_version.outputs.release_version
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Tag version
        run: |
          git tag ${{ needs.determine_version.outputs.release_version }}
          git push origin ${{ needs.determine_version.outputs.release_version }}
      - uses: actions/download-artifact@v5
      - run: ls -al
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.determine_version.outputs.release_version }}
          files: |
            ./**/*.vsix

      - name: Install ovsx
        run: npm install --global ovsx
      - name: Publish extension
        run: ovsx publish ./*.vsix
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
