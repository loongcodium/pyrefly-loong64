From 32be48134d08688168c528cbeeddcd3f102a3d8c Mon Sep 17 00:00:00 2001
From: SkyBird233 <52884766+SkyBird233@users.noreply.github.com>
Date: Sat, 7 Feb 2026 19:42:37 +0800
Subject: [PATCH] fix: correctly feature-gate backtrace-on-stack-overflow

---
 pyrefly/Cargo.toml  | 5 ++++-
 pyrefly/bin/main.rs | 2 +-
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/pyrefly/Cargo.toml b/pyrefly/Cargo.toml
index b73c3de27..5e81f74df 100644
--- a/pyrefly/Cargo.toml
+++ b/pyrefly/Cargo.toml
@@ -69,7 +69,7 @@ yansi = { version = "1.0.0-rc.1", features = ["hyperlink"] }
 pretty_assertions = { version = "1.2", features = ["alloc"], default-features = false }
 
 [target.'cfg(any(target_os = "linux", target_os = "macos"))'.dependencies]
-backtrace-on-stack-overflow = "0.3"
+backtrace-on-stack-overflow = { version = "0.3", optional = true }
 tikv-jemallocator = "0.6.0"
 
 [target.'cfg(target_os = "windows")'.dependencies]
@@ -77,3 +77,6 @@ mimalloc = "0.1.46"
 
 [lints]
 rust = { unexpected_cfgs = { check-cfg = ["cfg(fbcode_build)", 'cfg(feature, values("debug-stack-overflow"))'], level = "warn" } }
+
+[features]
+debug-stack-overflow = ["dep:backtrace-on-stack-overflow"]
diff --git a/pyrefly/bin/main.rs b/pyrefly/bin/main.rs
index eeb28dad3..cbcccc1c0 100644
--- a/pyrefly/bin/main.rs
+++ b/pyrefly/bin/main.rs
@@ -60,7 +60,7 @@ async fn main() -> ExitCode {
     // Enable stack overflow backtraces for debugging.
     // This is unsafe and only intended for debug builds.
     #[cfg(not(windows))]
-    #[cfg(feature = "debug-stack-overflow")]
+    #[cfg(all(feature = "debug-stack-overflow", debug_assertions))]
     unsafe {
         backtrace_on_stack_overflow::enable();
     }
-- 
2.52.0

